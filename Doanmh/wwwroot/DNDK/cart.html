<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Giỏ hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Giỏ hàng của bạn</h2>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Sản phẩm</th>
                    <th>Số lượng</th>
                    <th>Giá</th>
                    <th>Tổng</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody id="cart-body">
                <!-- Dữ liệu từ server sẽ hiển thị tại đây -->
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3" class="text-end fw-bold">Tổng cộng:</td>
                    <td id="cart-total" class="fw-bold"></td>
                    <td></td>
                </tr>
            </tfoot>
        </table>

        <div class="d-flex justify-content-end">
            <button class="btn btn-success" onclick="thanhtoan()">Tới trang thanh toán</button>
        </div>
    </div>

    <script>
        const API_BASE = "https://localhost:7218/api/cart"; // Đảm bảo dùng đúng HTTPS

        async function loadCart() {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("Bạn chưa đăng nhập. Vui lòng đăng nhập trước.");
                return;
            }

            try {
                const response = await fetch(API_BASE, {
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Lỗi khi gọi API: ${response.status}`);
                }

                const cart = await response.json();

                const body = document.getElementById("cart-body");
                const totalEl = document.getElementById("cart-total");
                body.innerHTML = "";

                if (cart.length === 0) {
                    body.innerHTML = "<tr><td colspan='5' class='text-center'>Không có sản phẩm nào trong giỏ hàng</td></tr>";
                    totalEl.innerText = "0 VND";
                    return;
                }

                let total = 0;

                cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;

                    const row = document.createElement("tr");
                    row.innerHTML = `
                            <td>${item.name}</td>
                            <td>${item.quantity}</td>
                            <td>${item.price.toLocaleString()} VND</td>
                            <td>${itemTotal.toLocaleString()} VND</td>
                            <td><button class="btn btn-danger btn-sm" onclick="removeItem(${item.productId})">Xóa</button></td>
                        `;
                    body.appendChild(row);
                });

                totalEl.innerText = total.toLocaleString() + " VND";

            } catch (error) {
                console.error("Lỗi khi tải giỏ hàng:", error);
                alert("Không thể tải giỏ hàng.");
            }
        }

        async function removeItem(productId) {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("Bạn chưa đăng nhập.");
                return;
            }

            try {
                await fetch(`${API_BASE}/remove/${productId}`, {
                    method: "DELETE",
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                });
                await loadCart();
            } catch (err) {
                console.error("Lỗi khi xóa:", err);
                alert("Không thể xóa sản phẩm.");
            }
        }

        function thanhtoan() {
            alert("Chuyển đến trang thanh toán...");
            window.location.href = "thanhtoan.html";
        }

        document.addEventListener("DOMContentLoaded", loadCart);
    </script>
</body>
</html>
