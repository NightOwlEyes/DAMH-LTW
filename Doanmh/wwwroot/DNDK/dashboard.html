<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <title>Danh sách món ăn</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <style>
        .card-img-top {
            height: 200px;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Danh sách món ăn</h2>
            <div>
                <button onclick="viewCart()" class="btn btn-primary me-2">
                    🛒 Giỏ hàng (<span id="cart-count">0</span>)
                </button>
                <button onclick="logout()" class="btn btn-danger">Đăng xuất</button>
            </div>
        </div>
        <div id="product-list" class="row row-cols-1 row-cols-md-3 g-4">
            <!-- Danh sách món ăn sẽ được load tại đây -->
        </div>
    </div>

    <script>
        // Hàm giải mã payload trong token JWT
        function parseJwt(token) {
            try {
                const base64Payload = token.split('.')[1];
                const payload = atob(base64Payload);
                return JSON.parse(payload);
            } catch (e) {
                return null;
            }
        }

        // Kiểm tra token có hợp lệ và chưa hết hạn không
        function validateToken() {
            const token = localStorage.getItem("token");
            if (!token) return false;

            const payload = parseJwt(token);
            if (!payload || !payload.id) {
                alert("Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.");
                localStorage.removeItem("token");
                window.location.href = "login.html";
                return false;
            }

            const now = Math.floor(Date.now() / 1000);
            if (payload.exp && payload.exp < now) {
                alert("Token đã hết hạn. Vui lòng đăng nhập lại.");
                localStorage.removeItem("token");
                window.location.href = "login.html";
                return false;
            }

            return true;
        }

        if (!validateToken()) {
            // Token không hợp lệ hoặc hết hạn -> đã redirect rồi nên không cần làm gì thêm
        } else {
            document.addEventListener("DOMContentLoaded", loadProducts);
        }

        let productData = [];

        async function loadProducts() {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("Bạn chưa đăng nhập!");
                window.location.href = "login.html";
                return;
            }

            updateCartCount(); // Load số lượng giỏ hàng lúc đầu

            try {
                const res = await fetch("https://localhost:7218/api/productapi", {
                    headers: {
                        "Authorization": "Bearer " + token
                    }
                });

                if (!res.ok) throw new Error("Không thể tải sản phẩm. Token có thể đã hết hạn.");

                const data = await res.json();
                productData = data;
                const list = document.getElementById("product-list");
                list.innerHTML = "";

                if (data.length === 0) {
                    list.innerHTML = "<p class='text-center'>Không có sản phẩm nào.</p>";
                    return;
                }

                data.forEach(sp => {
                    const ten = sp.name || "Không rõ tên";
                    const gia = typeof sp.price === "number" ? sp.price.toLocaleString() : "Không rõ";
                    const img = sp.imageUrl || "https://via.placeholder.com/300x200?text=No+Image";

                    const card = document.createElement("div");
                    card.className = "col";

                    card.innerHTML = `
                            <div class="card h-100">
                                <img src="${img}" class="card-img-top" alt="${ten}">
                                <div class="card-body">
                                    <h5 class="card-title">${ten}</h5>
                                    <p class="card-text text-success fw-bold">${gia} VND</p>
                                </div>
                                <div class="card-footer text-center">
                                    <div class="input-group mb-2 justify-content-center">
                                        <input type="number" id="qty-${sp.id}" class="form-control text-center" value="1" min="1" style="max-width: 80px;" />
                                        <button class="btn btn-outline-dark ms-2" onclick="addToCart(${sp.id})">
                                            <i class="bi bi-cart-fill me-1"></i> Thêm vào giỏ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    list.appendChild(card);
                });

            } catch (err) {
                alert(err.message);
                window.location.href = "login.html";
            }
        }

        function logout() {
            localStorage.removeItem("token");
            window.location.href = "login.html";
        }

        function viewCart() {
            window.location.href = "cart.html";
        }

        async function addToCart(productId) {
            const token = localStorage.getItem("token");
            const product = productData.find(p => p.id === productId);
            if (!product) {
                alert("Không tìm thấy sản phẩm!");
                return;
            }

            const qtyInput = document.getElementById(`qty-${productId}`);
            const quantity = parseInt(qtyInput.value) || 1;

            const cartItem = {
                productId: product.id,
                name: product.name,
                price: product.price,
                quantity: quantity
            };

            try {
                const res = await fetch("https://localhost:7218/api/cart/add", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify(cartItem)
                });

                if (!res.ok) throw new Error("Lỗi khi thêm vào giỏ hàng.");

                alert("Đã thêm vào giỏ hàng!");
                updateCartCount();
            } catch (error) {
                console.error("Lỗi:", error);
                alert("Không thể thêm vào giỏ.");
            }
        }

        async function updateCartCount() {
            const token = localStorage.getItem("token");
            if (!token) return;

            try {
                const res = await fetch("https://localhost:7218/api/cart", {
                    headers: {
                        "Authorization": "Bearer " + token
                    }
                });

                if (!res.ok) throw new Error("Không lấy được giỏ hàng.");

                const cartItems = await res.json();
                const totalCount = cartItems.reduce((sum, item) => sum + item.quantity, 0);
                document.getElementById("cart-count").textContent = totalCount;
            } catch (err) {
                console.error("Không thể cập nhật giỏ hàng:", err);
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
