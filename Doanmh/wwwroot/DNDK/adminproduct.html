<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý sản phẩm (Admin)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">
    <h2>Quản lý sản phẩm</h2>

    <!-- Form thêm/sửa -->
    <form id="productForm" class="mb-4" enctype="multipart/form-data">
        <input type="hidden" id="productId" />
        <div class="mb-2">
            <label for="name" class="form-label">Tên sản phẩm</label>
            <input type="text" id="name" class="form-control" required>
        </div>
        <div class="mb-2">
            <label for="price" class="form-label">Giá</label>
            <input type="number" id="price" class="form-control" required>
        </div>
        <div class="mb-2">
            <label for="description" class="form-label">Mô tả</label>
            <input type="text" id="description" class="form-control">
        </div>
        <div class="mb-2">
            <label for="imageFile" class="form-label">Chọn ảnh</label>
            <input type="file" id="imageFile" class="form-control" accept="image/*">
        </div>
        <div class="mb-2">
            <img id="previewImage" src="#" alt="Ảnh xem trước" height="80" style="display: none;" />
        </div>
        <button type="submit" class="btn btn-primary">Lưu</button>
        <button type="button" onclick="resetForm()" class="btn btn-secondary">Hủy</button>
    </form>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Tên</th>
                <th>Giá</th>
                <th>Ảnh</th>
                <th>Mô tả</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody id="productTable"></tbody>
    </table>

    <script>
        const apiUrl = "https://localhost:7218/api/ProductApi";
        const token = localStorage.getItem("token");

        document.addEventListener("DOMContentLoaded", loadProducts);
        document.getElementById("productForm").addEventListener("submit", saveProduct);

        async function loadProducts() {
            const res = await fetch(apiUrl, {
                headers: { Authorization: "Bearer " + token }
            });
            const data = await res.json();
            const table = document.getElementById("productTable");
            table.innerHTML = "";

            data.forEach(p => {
                table.innerHTML += `
                        <tr>
                            <td>${p.name}</td>
                            <td>${p.price}</td>
                            <td><img src="${p.imageUrl || '#'}" height="50"/></td>
                            <td>${p.description || ""}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick='editProduct(${JSON.stringify(p)})'>Sửa</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProduct(${p.id})">Xoá</button>
                            </td>
                        </tr>`;
            });
        }

        function editProduct(p) {
            document.getElementById("productId").value = p.id;
            document.getElementById("name").value = p.name;
            document.getElementById("price").value = p.price;
            document.getElementById("description").value = p.description || "";

            const preview = document.getElementById("previewImage");
            if (p.imageUrl) {
                preview.src = p.imageUrl;
                preview.style.display = "block";
            } else {
                preview.style.display = "none";
            }
        }

        async function saveProduct(e) {
            e.preventDefault();

            const id = document.getElementById("productId").value;
            const formData = new FormData();

            formData.append("Id", id ? parseInt(id) : 0);
            formData.append("Name", document.getElementById("name").value);
            formData.append("Price", parseFloat(document.getElementById("price").value));
            formData.append("Description", document.getElementById("description").value);

            const fileInput = document.getElementById("imageFile");
            if (fileInput.files.length > 0) {
                formData.append("ImageFile", fileInput.files[0]);
            }

            const method = id ? "PUT" : "POST";
            const url = id ? `${apiUrl}/${id}` : apiUrl;

            const res = await fetch(url, {
                method,
                headers: { Authorization: "Bearer " + token },
                body: formData
            });

            if (res.ok) {
                resetForm();
                loadProducts();
                alert("Thành công!");
            } else {
                alert("Lỗi: Không thể lưu sản phẩm.");
            }
        }

        function resetForm() {
            document.getElementById("productForm").reset();
            document.getElementById("productId").value = "";
            document.getElementById("previewImage").style.display = "none";
        }

        async function deleteProduct(id) {
            if (!confirm("Bạn có chắc muốn xoá không?")) return;

            const res = await fetch(`${apiUrl}/${id}`, {
                method: "DELETE",
                headers: { Authorization: "Bearer " + token }
            });

            if (res.ok) {
                loadProducts();
                alert("Đã xoá!");
            } else {
                alert("Không thể xoá sản phẩm.");
            }
        }
    </script>
</body>
</html>
